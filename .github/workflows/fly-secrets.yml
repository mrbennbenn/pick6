name: Update Fly.io Secrets

on:
  workflow_dispatch:

jobs:
  update-secrets:
    name: Update Fly.io secrets
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Show app info
        run: flyctl status
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "âŒ Error: DATABASE_URL not set in GitHub secrets"
            exit 1
          fi
          
          echo "âœ… Required secrets validated"
      
      - name: Stage secrets
        run: |
          echo "ğŸ” Staging DATABASE_URL..."
          flyctl secrets set DATABASE_URL="${{ secrets.DATABASE_URL }}" --stage
          
          echo "ğŸ” Staging SECURE_COOKIE..."
          flyctl secrets set SECURE_COOKIE="true" --stage
          
          echo "âœ… All secrets staged"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Deploy secrets
        run: |
          echo "ğŸš€ Deploying staged secrets..."
          flyctl secrets deploy
          echo "âœ… Secrets deployed"
          echo "âš ï¸  App will restart to apply changes"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
