# Artillery Load Test Configuration for Pick6
# Phase 1: Conservative thresholds for baseline establishment

config:
  target: "{{ $processEnvironment.TARGET_URL }}"
  processor: "./processor.js"
  
  # Load test phases - defaults that should be overridden via workflow
  # NOTE: Artillery doesn't support template interpolation for phase numbers
  # These will be overridden programmatically via processor
  # Phase 1: Spawn all users immediately
  # Phase 2: Let them run for the test duration
  phases:
    - duration: 1
      arrivalCount: 10
      name: "Initialize Users"
    - duration: 59
      arrivalRate: 0
      name: "Sustained Load"
  
  # Playwright engine configuration
  engines:
    playwright:
      aggregateByName: true
      launchOptions:
        headless: true
        args:
          - '--disable-dev-shm-usage'
          - '--no-sandbox'
  
  # Phase 1 Conservative Thresholds
  ensure:
    # Error rate thresholds (generous for baseline)
    maxErrorRate: 10  # Fail if > 10% errors
    
    # Response time thresholds (very loose for initial baseline)
    p95: 5000  # Fail if P95 > 5 seconds
    p99: 10000  # Fail if P99 > 10 seconds
  
  # Warnings (logged but don't fail the test)
  thresholds:
    # Warn if error rate exceeds 2%
    - metric: http.response_time.p95
      value: 2000
      level: warn
    
    # Warn if P99 exceeds 3 seconds
    - metric: http.response_time.p99
      value: 3000
      level: warn
  
  # Plugin configuration
  plugins:
    expect: {}
    metrics-by-endpoint:
      # Group metrics by operation type
      stripQueryString: true
      ignoreUnknownEndpoints: false

# Test Scenario
scenarios:
  - name: "Complete User Journey"
    engine: playwright
    
    # Browser context setup (once per VU)
    beforeScenario: "createBrowserContext"
    
    # The main user journey
    flowFunction: "userJourney"
    
    # Cleanup after journey
    afterScenario: "closeBrowserContext"
